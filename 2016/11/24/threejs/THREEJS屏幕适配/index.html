<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="这篇文章只讨论 PerspectiveCamera 的适配方法
做过手机 H5 的同学可能会觉得屏幕适配挺麻烦。原因是设计师提供的设计稿尺寸比固定，但是前端开发者却要适配不同大小、长宽比的目标设备。适配的终极目标无非是最大程度把主体内容优雅地呈现给用户。开发和设计如果没有协调好的话可能会妥协比较丑陋">
    

    <!--Author-->
    
        <meta name="author" content="JasonTurbo">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="简单一招搞定 three.js 屏幕适配"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Jason&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>简单一招搞定 three.js 屏幕适配 - Jason&#39;s blog</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    

</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 ph5-ns ph3 text-light">
    
    <nav class="db dt-l w-100 mw8 center border-box pv3">
        <a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="Jason's blog">
            
            <img src="/images/avatar.jpg" class="v-mid dib h2 br-100" alt="Jason's blog"> &nbsp; Jason
        </a>
        <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/" 
                    title="首页">
                    首页
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/archives" 
                    title="归档">
                    归档
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/about.html" 
                    title="关于">
                    关于
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/contact.html" 
                    title="联系">
                    联系
                </a>
            
        </div>
    </nav>

    <!-- Title -->
    <div class="w-100 mw8 center vh-40 dt">
        <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns">简单一招搞定 three.js 屏幕适配</h1>
            <p class="f4 fw1 pab-100px tc tc-m tl-ns">2016-11-24</p>
        </div>
    </div>

    <!-- Icon
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon fa fa-file-text-o"></i>
    </div> -->
</div>

<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    
                        <div class="tags-container-vertical">
                            <div class="tags-sub-container">
                                <a class="fw3 ph1 dib" href="/tags/three-js/">#three.js</a>
                            </div>
                        </div>
                    

                    <!-- Main Post Content -->
                    <p>这篇文章只讨论 <span style="color: red">PerspectiveCamera</span> 的适配方法</p>
<p>做过手机 H5 的同学可能会觉得屏幕适配挺麻烦。原因是设计师提供的设计稿尺寸比固定，但是前端开发者却要适配不同大小、长宽比的目标设备。适配的终极目标无非是最大程度把主体内容优雅地呈现给用户。开发和设计如果没有协调好的话可能会妥协比较丑陋的方案，例如由于设计比例问题，为了照顾主体内容不被裁剪，只好设备两边，或者上下留黑边这种。</p>
<p>不过在 3D 的世界里，我们不用担心会有黑边的问题，因为 3D 场景是无限延伸的，总能填满任何比例的屏幕。</p>
<p>先看看 PerspectiveCamera 官方 API 说明如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PerspectiveCamera( fov, aspect, near, far )</div><div class="line"></div><div class="line">fov — Camera frustum vertical field of view.</div><div class="line">aspect — Camera frustum aspect ratio.</div><div class="line">near — Camera frustum near plane.</div><div class="line">far — Camera frustum far plane.</div></pre></td></tr></table></figure>
<p>上面四个参数都会影响成像结果，<code>fov</code> 和 <code>aspect</code> 设置 XY 平面的范围，也就是广度。 <code>near</code> 和 <code>far</code> 影响的是纵深 Z 轴的范围，也就是深度。纵深只要保证物体离相机距离在这个范围就可以了，这是为了性能而设置的参数，由用户设置，只渲染必要的东西。实际上真实的相机这两个值对应的是 0 到 无限远。</p>
<p>这些参数设置好之后，成像就相应确定了。最后 three.js 把相机拍摄到的矩形区域对应好四个顶点渲染到屏幕上。<span style="color: red">同样比例的屏幕看到的图像是一致的，与屏幕大小无关</span>。</p>
<img src="/2016/11/24/threejs/THREEJS屏幕适配/photo.jpg" alt="photo.jpg" title="">
<p>下面我用一个简单的场景来看一下这些参数对成像的影响。</p>
<h2 id="场景元素"><a href="#场景元素" class="headerlink" title="场景元素"></a>场景元素</h2><ul>
<li>相机 （PerspectiveCamera）</li>
<li>一个边长为 100 的平面（主体内容范围），放在世界坐标中心。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> camera = <span class="keyword">new</span> THREE.PerspectiveCamera(<span class="number">53</span>, <span class="number">500</span> / <span class="number">500</span>, <span class="number">0.1</span>, <span class="number">1000</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> planeGemo = <span class="keyword">new</span> THREE.PlaneGeometry( <span class="number">100</span>, <span class="number">100</span>, <span class="number">10</span>, <span class="number">10</span> )</div><div class="line"><span class="keyword">var</span> meshMaterial = <span class="keyword">new</span> THREE.MeshLambertMaterial();</div><div class="line">meshMaterial.color = <span class="keyword">new</span> THREE.Color(<span class="number">0x2dcaf1</span>);</div><div class="line">meshMaterial.side = THREE.DoubleSide;</div><div class="line"></div><div class="line"><span class="keyword">var</span> wireFrameMat = <span class="keyword">new</span> THREE.MeshBasicMaterial();</div><div class="line">wireFrameMat.color = <span class="keyword">new</span> THREE.Color(<span class="number">0xdddddd</span>);</div><div class="line">wireFrameMat.wireframe = <span class="literal">true</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> plane = THREE.SceneUtils.createMultiMaterialObject(planeGemo, [meshMaterial, wireFrameMat]);</div><div class="line"></div><div class="line">scene.add(plane);</div></pre></td></tr></table></figure>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>在任何屏幕下，都能最大程度地显示完整的立方体。最大程度，就是最少多余空间的意思。下面是要达到效果</p>
<img src="/2016/11/24/threejs/THREEJS屏幕适配/plane.jpg" alt="plane.jpg" title="">
<h2 id="设置-fov-参数"><a href="#设置-fov-参数" class="headerlink" title="设置 fov 参数"></a>设置 fov 参数</h2><p>可以直接想到的一种适配方法是——改变 camera 到目标物体的距离以控制成像的内容，但是这样做计算成本比较高，而且还有可能影响其他一些数值，然后需要相应一起计算修改。<br>我想到改变视角也可以达到控制成像内容多少的目的，于是我想可不可以只通过改变 fov 一个数值，达到我要的效果。</p>
<p>fov 官网的定义翻译过来是垂直方向的视角大小。我们先规定好相机到平面的距离为 100，然后试试看能不能通过计算设置 fov 值，刚好让平面填满一个宽高比为 1:1 的屏幕。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">plane.position.set(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">camera.position.set(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>);</div><div class="line">camera.lookAt(<span class="keyword">new</span> THREE.Vector3);</div></pre></td></tr></table></figure>
<img src="/2016/11/24/threejs/THREEJS屏幕适配/fov.jpg" alt="fov.jpg" title="">
<p>观察上面的图，可以很容易求出 fov 的值， fov = arctan((100/2)/100) * 2; fov 为 0.9272952180016122，约等于 53 度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">camera.fov = <span class="built_in">Math</span>.atan((<span class="number">100</span>/<span class="number">2</span>)/<span class="number">100</span>) * <span class="number">2</span> * (<span class="number">180</span> / <span class="built_in">Math</span>.PI);</div><div class="line">camera.updateProjectionMatrix();</div></pre></td></tr></table></figure>
<p>设置完刚刚求出的 fov 值，将场景渲染到 宽高比为 1:1 的画布上。</p>
<p><img src="/2016/11/24/threejs/THREEJS屏幕适配/fovinit.png" width="200" height="200"></p>
<p>渲染结果和预想的一样，平面刚好填满了 1:1 的画布。</p>
<h2 id="fov-和宽高比例的关系"><a href="#fov-和宽高比例的关系" class="headerlink" title="fov 和宽高比例的关系"></a>fov 和宽高比例的关系</h2><p>下面在固定的 fov 下，使用 dat.gui 工具调整宽高比，观察渲染区域的变化。</p>
<img src="/2016/11/24/threejs/THREEJS屏幕适配/fov-to-height.jpg" alt="fov-to-height.jpg" title="">
<p>因为fov设置的是垂直方向的视角范围，可以看到无论我们怎么改变宽高比例，垂直方向的渲染范围，都是一致的。水平方向则是以裁剪的方式显示。也就是说当我们设置好视角让垂直方向范围刚好等于主体内容的范围，只要宽高比大于1，我们得到的渲染结果，已经是最佳的了。问题就只剩下当宽高比小于1的情况了。</p>
<p>宽高比小于1的时候，垂直方向显示的高度刚好是等于主体内容的高度。为了能让水平方向完整显示主体内容，我们只有将垂直方向范围增大，也就是将 fov 设置一个更大的值，此时水平方向的范围也会随之增大。当将 fov调整到 水平方向刚好能显示主体内容时，垂直方向此时显示的范围是超过主体内容垂直方向的范围的。其中的关系，其实可以用很简单的函数求出来。</p>
<p>已知 照相机到主题内容的距离为 d<br>正方形主体内容的边长为 w</p>
<p>设宽高比为 r，求照相机垂直方向的视角 f</p>
<p>当 r &gt;= 1 时，照相机拍摄到的垂直方向范围等于 w</p>
<p>当 r &gt; 1<br><code>d * tan(f/2) * 2 = w</code></p>
<p>当 r &lt; 1 时，照相机拍摄到的水平方向范围等于 w，垂直方向范围应该是 w/r<br><code>d * tan(f/2) * 2 = w/r</code></p>
<p>这样，任意宽高比例的屏幕应该对应多大的垂直视角就确定了。</p>
<h2 id="最终代码与效果"><a href="#最终代码与效果" class="headerlink" title="最终代码与效果"></a>最终代码与效果</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> controls = <span class="keyword">new</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    camera.position.z = CAMERA_TO_MAIN_DIS;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.width = <span class="number">500</span>;</div><div class="line">    <span class="keyword">this</span>.height = <span class="number">500</span>;</div><div class="line">    <span class="keyword">this</span>.planeRY = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">calcFov</span>(<span class="params">d, w, r</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> f;</div><div class="line">        <span class="keyword">var</span> vertical = w;</div><div class="line">        <span class="keyword">if</span> (r &lt; <span class="number">1</span>) &#123;</div><div class="line">            vertical = vertical/r;</div><div class="line">        &#125;</div><div class="line">        f = <span class="built_in">Math</span>.atan(vertical/d/<span class="number">2</span>)*<span class="number">2</span> * (<span class="number">180</span> / <span class="built_in">Math</span>.PI);</div><div class="line">        <span class="keyword">return</span> f;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.redraw = <span class="function"><span class="params">()</span>=&gt;</span>&#123;</div><div class="line">        webGLRenderer.setSize(<span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</div><div class="line">        plane.rotation.y = <span class="keyword">this</span>.planeRY;</div><div class="line">        camera.fov = calcFov(CAMERA_TO_MAIN_DIS, MAIN_CONTENT_WIDTH, <span class="keyword">this</span>.width / <span class="keyword">this</span>.height);</div><div class="line">        camera.aspect = <span class="keyword">this</span>.width / <span class="keyword">this</span>.height;</div><div class="line">        camera.updateProjectionMatrix();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效果：<br><img src="/2016/11/24/threejs/THREEJS屏幕适配/fov-to-height-final.jpg" alt="fov-to-height-final.jpg" title=""></p>
<p>demo 的完整代码：<a href="http://codepen.io/JasonTurbo/pen/ZLwJMo" target="_blank" rel="external">http://codepen.io/JasonTurbo/pen/ZLwJMo</a></p>

                    
                    <!-- Tags Bottom -->
                    
                        <div class="tags-container-bottom">
                            <i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/three-js/">#three.js</a>
                        </div>
                    

                    <!-- Comments -->
                    



                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                    
                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 1: About -->
                    <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="/images/avatar.jpg" class="mb4-l h3 w3 h4-l w4-l dib" title="JasonTurbo">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            My name is Zhouzhichuang. You can call me Jason. I was born in 1991s.
        </div>
    </article>
</div>

                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 2: Categories -->
                    
                        <div class="mt5 tc tl-l">
    <h3>分类</h3>
    
        <p>
            <a href="/categories/three-js/">three.js</a>
        </p>
    
</div>


                        <hr class="dn-l mw4 black-50 mt5" />
                    

                    <!-- Widget 3: Recent Posts -->
                    <div class="mt5 tc tl-l">
    <h3>最新文章</h3>
    
        <p>
            <a href="/2017/02/11/linux/shell基础/">Shell 基础</a>
        </p>
    
        <p>
            <a href="/2016/11/24/design/cssartppt读后感/">IMPRESSIVE ART IN CSS 分享读后感</a>
        </p>
    
        <p>
            <a href="/2016/11/24/threejs/THREEJS屏幕适配/">简单一招搞定 three.js 屏幕适配</a>
        </p>
    
        <p>
            <a href="/2016/05/11/git/gitssh/">通过配置ssh密钥认证连接Git</a>
        </p>
    
        <p>
            <a href="/2016/04/12/git/gitcancel/">Git 撤销操作</a>
        </p>
    
</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv4">
        <div class="mv8">
            <div class="center tc">
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://github.com/zhzhchwin" target="_blank">
                            <i class="fa fa-github"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://codepen.io/JasonTurbo/" target="_blank">
                            <i class="fa fa-codepen"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="mailto:576073927@qq.com" target="_blank">
                            <i class="fa fa-envelope"></i>
                        </a>
                    </div>
                
            </div>
            <!--div class="f6 f5-ns center tc white pt5 fw3">
                
            </div-->
        </div>
    </div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>